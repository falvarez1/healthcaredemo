@using Stl.Async
@implements IDisposable

<div>
    <MudText Inline="true">Component state: </MudText>
    @if (IsLoading)
            {
        <MudChip Icon="@Icons.Material.Outlined.Check">Loading...</MudChip>

            }
    else if (IsUpdating){
        <MudChip Icon="@Icons.Material.Outlined.Check">Updating...</MudChip>

            }
                else if (IsUpdatePending) { 
        <MudChip Icon="@Icons.Material.Outlined.Check">Updating pending...</MudChip>
    
    }
    else  {
        <MudChip Icon="@Icons.Material.Outlined.Check">In sync</MudChip>
    }
</div>

@code {
    private readonly Action<IState, StateEventKind> _stateChangedHandler;
    private IState _state = null!;

    [Parameter]
    public IState State
    {
        get => _state;
        set
        {
            if (_state == value)
                return;
            _state?.RemoveEventHandler(StateEventKind.All, _stateChangedHandler);
            _state = value;
            _state?.AddEventHandler(StateEventKind.All, _stateChangedHandler);
        }
    }

    public bool IsLoading => State == null! || State.Snapshot.UpdateCount == 0;
    public bool IsUpdating => State == null! || State.Snapshot.WhenUpdating().IsCompleted;
    public bool IsUpdatePending => State == null! || State.Snapshot.Computed.IsInvalidated();

    public StatefulComponentState()
        => _stateChangedHandler = (_1, _2) => this.StateHasChangedAsync().Ignore();

    public virtual void Dispose()
        => State = null!;
}
